<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>洗剤カウンター</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 40px; }
    .progress { width: 100%; background: #eee; height: 24px; border-radius: 12px; overflow: hidden; margin: 20px 0; }
    .bar { height: 100%; background: #2e7d32; width: 0%; transition: width 0.6s ease; color: #fff; display:flex; align-items:center; justify-content:center; font-weight:bold; }
    button { padding: 15px 30px; font-size: 18px; margin: 20px; background:#1976d2; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    button:hover { background:#1565c0; }
    button:disabled { background:#999; cursor: not-allowed; }
    #message { margin-top: 15px; font-size: 16px; color: #333; }
    #message.warning { color: #d32f2f; font-weight:bold; }
    #download-btn { background: #4caf50; }
    #download-btn:hover { background: #388e3c; }
    #use-btn { background: #ff9800; }
    #use-btn:hover { background: #f57c00; }
  </style>
</head>
<body>
  <h1>部屋干しスーパークリーン</h1>
  <p>残り: <span id="remaining">読み込み中...</span> 回</p>
  <div class="progress"><div class="bar" id="bar">0%</div></div>
  <button id="use-btn" disabled>使用する</button>
  <button id="download-btn">履歴をCSVでダウンロード</button>
  <p><small>※1回の使用量: 22ml</small></p>
  <div id="message" role="status" aria-live="polite"></div>

  <script>
    // 設定
    const SUPABASE_URL = "https://vnzyqgrkjkeiwahainnc.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuenlxZ3JramtlaXdhaGFpbm5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzM1OTIsImV4cCI6MjA3MTYwOTU5Mn0.r5tCYxwjEagU7ZejUzv8Pblt1Pn5xtppE89lMdFsVHg";
    const UID = "ABC123";
    const TOTAL_REFILLS = 83;         // 全体の使用可能回数
    const MAX_USES_PER_DAY = 3;       // 1日最大使用回数

    // Supabaseクライアント
    const client = axios.create({
      baseURL: `${SUPABASE_URL}/rest/v1`,
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`,
      },
    });

    // JSTの日付文字列 (YYYY-MM-DD)
    function getJSTDateString(date = new Date()) {
      const jst = new Date(date.getTime() + 9 * 60 * 60 * 1000);
      return jst.toISOString().split("T")[0];
    }

    // JSTの範囲をUTCに変換（Supabase用）
    function getTodayUTCRange() {
      const today = getJSTDateString();
      const start = new Date(today + "T00:00:00+09:00").toISOString();
      const end = new Date(today + "T23:59:59+09:00").toISOString();
      return { start, end };
    }

    // 今日の使用回数を取得
    async function getTodayUses() {
      try {
        const { start, end } = getTodayUTCRange();
        const res = await client.get(`/detergent_logs`, {
          params: {
            select: 'id',
            and: `user_id.eq.${UID},used_at.gte.${start},used_at.lt.${end}`
          }
        });
        return res.data.length;
      } catch (e) {
        console.warn("今日の使用回数取得失敗:", e.message);
        return 0;
      }
    }

    // 総使用回数を取得
    async function getTotalUses() {
      try {
        const res = await client.get(`/detergent_logs`, {
          params: {
            select: 'id',
            user_id: `eq.${UID}`
          }
        });
        return res.data.length;
      } catch (e) {
        console.warn("総使用回数取得失敗:", e.message);
        return 0;
      }
    }

    // 使用ログを記録
    async function logUse() {
      try {
        await client.post(`/detergent_logs`, {
          user_id: UID,
          amount_ml: 22,
          used_at: new Date().toISOString()
        }, {
          headers: {
            'Content-Type': 'application/json',
            apikey: SUPABASE_KEY,
            Authorization: `Bearer ${SUPABASE_KEY}`
          }
        });
        return true;
      } catch (e) {
        console.error("ログ記録失敗:", e);
        return false;
      }
    }

    // UIを更新
    function updateUI(remaining, todayRemaining) {
      document.getElementById("remaining").textContent = remaining;
      const percent = Math.max(0, (remaining / TOTAL_REFILLS) * 100);
      const bar = document.getElementById("bar");
      bar.style.width = percent + "%";
      bar.textContent = Math.round(percent) + "%";

      // メッセージ
      if (remaining <= 10) {
        showMessage(`⚠️ 残り${remaining}回です。補充をご検討ください。`, true);
      } else if (remaining <= TOTAL_REFILLS / 2) {
        showMessage(`残り${remaining}回になりました（半分以下）。`, true);
      } else {
        showMessage(`残り${remaining}回使えます。`);
      }

      // 本日の残り回数
      if (todayRemaining > 0) {
        showMessage(`本日あと ${todayRemaining} 回 使用可能です。`, false, true);
      } else {
        showMessage(`本日の使用回数上限に達しました。`, true, true);
      }
    }

    // メッセージ表示
    function showMessage(text, warning = false, append = false) {
      const msg = document.getElementById("message");
      if (!append) msg.textContent = text;
      else msg.textContent += `\n${text}`;
      msg.className = warning ? "warning" : "";
    }

    // 使用処理
    async function handleUse() {
      const btn = document.getElementById("use-btn");
      btn.disabled = true;
      btn.textContent = "処理中...";

      try {
        const todayUses = await getTodayUses();
        if (todayUses >= MAX_USES_PER_DAY) {
          showMessage(`本日の使用回数上限 (${MAX_USES_PER_DAY}回) に達しました。`, true);
          return;
        }

        const success = await logUse();
        if (!success) {
          showMessage("使用の記録に失敗しました。", true);
          return;
        }

        // 再度取得して整合性を保つ
        const newTotal = await getTotalUses();
        const newToday = await getTodayUses();
        const remaining = Math.max(0, TOTAL_REFILLS - newTotal);
        const remainingToday = MAX_USES_PER_DAY - newToday;

        updateUI(remaining, remainingToday);

      } catch (e) {
        showMessage("エラーが発生しました: " + e.message, true);
      } finally {
        btn.disabled = false;
        btn.textContent = "使用する";
      }
    }

    // CSVダウンロード
    async function downloadCSV() {
      const btn = document.getElementById("download-btn");
      btn.disabled = true;
      btn.textContent = "準備中...";

      try {
        const res = await client.get(`/detergent_logs`, {
          params: {
            user_id: `eq.${UID}`,
            order: 'used_at',
            select: 'used_at, amount_ml'
          }
        });

        if (res.data.length === 0) {
          alert("履歴がありません。");
          return;
        }

        let csv = "日時,使用量(ml)\n";
        res.data.forEach(log => {
          const utc = new Date(log.used_at);
          const jst = new Date(utc.getTime() + 9 * 60 * 60 * 1000);
          const dateStr = jst.toLocaleString('ja-JP', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
          }).replace(/\//g, '-');
          csv += `"${dateStr}",${log.amount_ml}\n`;
        });

        const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `洗剤使用履歴_${getJSTDateString()}.csv`;
        a.click();
        URL.revokeObjectURL(url);

        showMessage("CSVをダウンロードしました。");
      } catch (e) {
        showMessage("履歴の取得に失敗しました。", true);
      } finally {
        setTimeout(() => {
          btn.disabled = false;
          btn.textContent = "履歴をCSVでダウンロード";
        }, 1000);
      }
    }

    // 初期化
    async function init() {
      try {
        const [totalUses, todayUses] = await Promise.all([
          getTotalUses(),
          getTodayUses()
        ]);

        const remaining = Math.max(0, TOTAL_REFILLS - totalUses);
        const remainingToday = MAX_USES_PER_DAY - todayUses;

        updateUI(remaining, remainingToday);

        // 本日回数未上限なら使用ボタンを有効化
        document.getElementById("use-btn").disabled = todayUses >= MAX_USES_PER_DAY;

      } catch (e) {
        showMessage("初期化に失敗しました。", true);
        console.error(e);
      }
    }

    // イベント登録
    document.getElementById("use-btn").addEventListener("click", handleUse);
    document.getElementById("download-btn").addEventListener("click", downloadCSV);

    // 初期化
    init();
  </script>
</body>
</html>
