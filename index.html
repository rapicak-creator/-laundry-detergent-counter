<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>洗剤カウンター</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 40px; background: #f9f9f9; }
    .progress { width: 100%; background: #eee; height: 24px; border-radius: 12px; overflow: hidden; margin: 20px 0; }
    .bar { height: 100%; background: #2e7d32; width: 0%; transition: width 0.6s ease; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    button { padding: 15px 30px; font-size: 18px; margin: 10px; background: #1976d2; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #1565c0; }
    #download-btn { background: #4caf50; }
    #download-btn:hover { background: #388e3c; }
    #message { margin-top: 15px; font-size: 16px; color: #333; min-height: 20px; }
    #message.warning { color: #d32f2f; font-weight: bold; }
    small { color: #666; }
  </style>
</head>
<body>
  <h1>部屋干しスーパークリーン</h1>
  <p>残り: <strong><span id="remaining">読み込み中...</span></strong> 回</p>
  <div class="progress">
    <div class="bar" id="bar">0%</div>
  </div>
  <button id="download-btn">履歴をCSVでダウンロード</button>
  <p><small>※1回の使用量: 22ml</small></p>
  <div id="message" role="status" aria-live="polite"></div>

  <script>
    // ===== 設定 =====
    const SUPABASE_URL = "https://vnzyqgrkjkeiwahainnc.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuenlxZ3JramtlaXdhaGFpbm5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzM1OTIsImV4cCI6MjA3MTYwOTU5Mn0.r5tCYxwjEagU7ZejUzv8Pblt1Pn5xtppE89lMdFsVHg";
    const UID = "ABC123";
    const USER_EMAIL = "rapicak@gmail.com";
    const MAX_USES_PER_DAY = 3;  // 1日最大使用回数
    const TOTAL_USES = 83;       // 全体の使用可能回数

    // ===== Supabase クライアント =====
    const client = axios.create({
      baseURL: `${SUPABASE_URL}/rest/v1`,
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`,
      },
      paramsSerializer: { indexes: null }
    });

    // ===== 今日の日付 (YYYY-MM-DD) =====
    function getToday() {
      return new Date().toISOString().split('T')[0];
    }

    // ===== 今日の使用回数を取得 =====
    async function getTodayUses() {
      try {
        const res = await client.get(`/daily_usage`, {
          params: {
            user_id: 'eq.' + UID,
            date: 'eq.' + getToday(),
            select: 'uses_count'
          }
        });
        return res.data.length > 0 ? res.data[0].uses_count : 0;
      } catch (e) {
        console.warn("今日の使用回数取得失敗:", e.message);
        return 0;
      }
    }

    // ===== 今日の使用回数を+1 =====
    async function incrementTodayUses() {
      const today = getToday();
      try {
        const res = await client.get(`/daily_usage`, {
          params: {
            user_id: 'eq.' + UID,
            date: 'eq.' + today
          }
        });

        if (res.data.length > 0) {
          await client.patch(`/daily_usage?id=eq.${res.data[0].id}`, {
            uses_count: res.data[0].uses_count + 1
          });
        } else {
          await client.post(`/daily_usage`, {
            user_id: UID,
            date: today,
            uses_count: 1
          });
        }
      } catch (e) {
        console.error("本日の使用回数記録失敗:", e.message);
      }
    }

    // ===== 使用ログ記録 =====
    async function logUse() {
      try {
        await client.post(`/detergent_logs`, {
          user_id: UID,
          amount_ml: 22
        });
      } catch (e) {
        console.warn("使用ログ記録失敗:", e.message);
      }
    }

    // ===== 残り回数を取得・初期化 =====
    async function loadRemaining() {
      try {
        const res = await client.get(`/detergent_usage?id=eq.${UID}`);
        if (res.data.length === 0) {
          // 初回ユーザー → 初期化
          await client.post(`/detergent_usage`, {
            id: UID,
            email: USER_EMAIL,
            current_uses: 0,
            notified_half: false,
            notified_low: false
          });
          return { current_uses: 0, notified_half: false, notified_low: false };
        } else {
          return res.data[0];
        }
      } catch (e) {
        console.error("データ読み込み失敗:", e.message);
        showMessage("データ取得に失敗しました。", true);
        return { current_uses: 0, notified_half: false, notified_low: false };
      }
    }

    // ===== 残り回数を更新 =====
    async function updateRemaining(newUses) {
      try {
        await client.patch(`/detergent_usage?id=eq.${UID}`, {
          current_uses: newUses
        });
      } catch (e) {
        console.warn("残り回数更新失敗:", e.message);
      }
    }

    // ===== CSVダウンロード =====
    async function downloadCSV() {
      try {
        const res = await client.get(`/detergent_logs`, {
          params: {
            user_id: 'eq.' + UID,
            order: 'used_at.desc',
            select: 'used_at, amount_ml'
          }
        });

        if (res.data.length === 0) {
          alert("使用履歴がありません。");
          return;
        }

        let csv = "日時,使用量(ml)\n";
        res.data.forEach(log => {
          const date = new Date(log.used_at).toLocaleString('ja-JP', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          }).replace(/\//g, '-');
          csv += `"${date}",${log.amount_ml}\n`;
        });

        const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `洗剤使用履歴_${getToday()}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        showMessage("CSVをダウンロードしました。");
      } catch (e) {
        showMessage("履歴の取得に失敗しました。", true);
      }
    }

    // ===== UI更新 =====
    function updateUI(remaining) {
      document.getElementById("remaining").textContent = remaining;
      const percent = Math.max(0, (remaining / TOTAL_USES) * 100);
      const bar = document.getElementById("bar");
      bar.style.width = `${percent}%`;
      bar.textContent = `${Math.round(percent)}%`;

      if (remaining <= 10) {
        showMessage(`⚠️ 残り${remaining}回です。補充をご検討ください。`, true);
      } else if (remaining <= TOTAL_USES / 2) {
        showMessage(`残り${remaining}回になりました（半分以下）。`);
      } else {
        showMessage(`残り${remaining}回使えます。`);
      }
    }

    // ===== メッセージ表示 =====
    function showMessage(text, warning = false) {
      const el = document.getElementById("message");
      el.textContent = text;
      el.className = warning ? "warning" : "";
    }

    // ===== 使用処理（1回分）=====
    async function useDetergent() {
      const todayUses = await getTodayUses();
      if (todayUses >= MAX_USES_PER_DAY) {
        const data = await loadRemaining();
        const remaining = TOTAL_USES - data.current_uses;
        updateUI(remaining);
        showMessage(`本日の使用回数上限 (${MAX_USES_PER_DAY}回) に達しました。`, true);
        return;
      }

      const data = await loadRemaining();
      const newUses = data.current_uses + 1;
      const remaining = TOTAL_USES - newUses;

      // DB更新
      await updateRemaining(newUses);
      await incrementTodayUses();
      await logUse();

      // メール通知（必要時）
      if (remaining <= TOTAL_USES / 2 && !data.notified_half) {
        try {
          await fetch(`/api/send-email`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ type: "半分", remaining, to: USER_EMAIL })
          });
          await client.patch(`/detergent_usage?id=eq.${UID}`, { notified_half: true });
        } catch (e) {
          console.warn("半分通知メール送信失敗:", e);
        }
      }
      if (remaining <= 10 && !data.notified_low) {
        try {
          await fetch(`/api/send-email`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ type: "残りわずか", remaining, to: USER_EMAIL })
          });
          await client.patch(`/detergent_usage?id=eq.${UID}`, { notified_low: true });
        } catch (e) {
          console.warn("残りわずか通知メール送信失敗:", e);
        }
      }

      // UI更新
      updateUI(remaining);

      // 本日残り回数
      const remainingToday = MAX_USES_PER_DAY - (todayUses + 1);
      if (remainingToday > 0) {
        showMessage(`本日あと ${remainingToday} 回 使用可能です。`);
      }
    }

    // ===== イベント登録 =====
    document.getElementById("download-btn").addEventListener("click", downloadCSV);

    // ===== ページ読み込み時 =====
    window.addEventListener("load", () => {
      useDetergent().catch(e => {
        console.error("自動使用処理失敗:", e);
        showMessage("処理に失敗しました。", true);
      });
    });
  </script>
</body>
</html>
