<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ´—å‰¤ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 40px; }
    .progress { width: 100%; background: #eee; height: 24px; border-radius: 12px; overflow: hidden; margin: 20px 0; }
    .bar { height: 100%; background: #2e7d32; width: 0%; transition: width 0.6s ease; color: #fff; display:flex; align-items:center; justify-content:center; font-weight:bold; }
    button { padding: 15px 30px; font-size: 18px; margin: 20px; background:#1976d2; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    button:hover { background:#1565c0; }
    button:disabled { background:#999; cursor: not-allowed; }
    #message { margin-top: 15px; font-size: 16px; color: #333; }
    #message.warning { color: #d32f2f; font-weight:bold; }
    #download-btn { background: #4caf50; }
    #download-btn:hover { background: #388e3c; }
    #use-btn { background: #ff9800; }
    #use-btn:hover { background: #f57c00; }
  </style>
</head>
<body>
  <h1>éƒ¨å±‹å¹²ã—ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¯ãƒªãƒ¼ãƒ³</h1>
  <p>æ®‹ã‚Š: <span id="remaining">èª­ã¿è¾¼ã¿ä¸­...</span> å›</p>
  <div class="progress"><div class="bar" id="bar">0%</div></div>
  <button id="use-btn" disabled>ä½¿ç”¨ã™ã‚‹</button>
  <button id="download-btn">å±¥æ­´ã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
  <p><small>â€»1å›ã®ä½¿ç”¨é‡: 22ml</small></p>
  <div id="message" role="status" aria-live="polite"></div>

  <script>
    // ===== è¨­å®šï¼ˆã“ã“ã ã‘ä¿®æ­£ï¼‰=====
    const SUPABASE_URL = "https://vnzyqgrkjkeiwahainnc.supabase.co";  // ã‚¹ãƒšãƒ¼ã‚¹ãªã—
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuenlxZ3JramtlaXdhaGFpbm5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzM1OTIsImV4cCI6MjA3MTYwOTU5Mn0.r5tCYxwjEagU7ZejUzv8Pblt1Pn5xtppE89lMdFsVHg"; // ã‚¹ãƒšãƒ¼ã‚¹ãªã—
    const UID = "ABC123";
    const TOTAL_REFILLS = 83;
    const MAX_USES_PER_DAY = 3;
    // ==============================

    const client = axios.create({
      baseURL: `${SUPABASE_URL}/rest/v1`,
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`,
      },
    });

    // JSTã®æ—¥ä»˜
    function getJSTDateString(date = new Date()) {
      const jst = new Date(date.getTime() + 9 * 60 * 60 * 1000);
      return jst.toISOString().split("T")[0];
    }

    function getTodayUTCRange() {
      const today = getJSTDateString();
      const start = new Date(today + "T00:00:00+09:00").toISOString();
      const end = new Date(today + "T23:59:59+09:00").toISOString();
      return { start, end };
    }

    async function getTodayUses() {
      try {
        const { start, end } = getTodayUTCRange();
        const res = await client.get(`/detergent_logs`, {
          params: {
            select: 'id',
            and: `user_id.eq.${UID},used_at.gte.${start},used_at.lt.${end}`
          }
        });
        return res.data.length;
      } catch (e) {
        console.warn("ä»Šæ—¥ã®ä½¿ç”¨å›æ•°å–å¾—å¤±æ•—:", e.response?.data || e.message);
        return 0;
      }
    }

    async function getTotalUses() {
      try {
        const res = await client.get(`/detergent_logs`, {
          params: {
            select: 'id',
            user_id: `eq.${UID}`
          }
        });
        return res.data.length;
      } catch (e) {
        console.warn("ç·ä½¿ç”¨å›æ•°å–å¾—å¤±æ•—:", e.response?.data || e.message);
        return 0;
      }
    }

    async function logUse() {
      try {
        const now = new Date().toISOString(); // æ­£ã—ã„ISOå½¢å¼

        const res = await client.post(`/detergent_logs`, {
          user_id: UID,
          amount_ml: 22,
          used_at: now
        }, {
          headers: {
            'Content-Type': 'application/json',
            apikey: SUPABASE_KEY,
            Authorization: `Bearer ${SUPABASE_KEY}`
          }
        });

        console.log("ãƒ­ã‚°è¨˜éŒ²æˆåŠŸ:", res.data);
        return true;
      } catch (e) {
        // ğŸ”¥ ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’ç¢ºèª
        console.error("ãƒ­ã‚°è¨˜éŒ²å¤±æ•—:", {
          status: e.response?.status,
          data: e.response?.data,
          message: e.message,
          url: `${SUPABASE_URL}/rest/v1/detergent_logs`,
          key: SUPABASE_KEY.length,
        });
        return false;
      }
    }

    function updateUI(remaining, todayRemaining) {
      document.getElementById("remaining").textContent = remaining;
      const percent = Math.max(0, (remaining / TOTAL_REFILLS) * 100);
      const bar = document.getElementById("bar");
      bar.style.width = percent + "%";
      bar.textContent = Math.round(percent) + "%";

      if (remaining <= 10) {
        showMessage(`âš ï¸ æ®‹ã‚Š${remaining}å›ã§ã™ã€‚è£œå……ã‚’ã”æ¤œè¨ãã ã•ã„ã€‚`, true);
      } else if (remaining <= TOTAL_REFILLS / 2) {
        showMessage(`æ®‹ã‚Š${remaining}å›ã«ãªã‚Šã¾ã—ãŸï¼ˆåŠåˆ†ä»¥ä¸‹ï¼‰ã€‚`, true);
      } else {
        showMessage(`æ®‹ã‚Š${remaining}å›ä½¿ãˆã¾ã™ã€‚`);
      }

      if (todayRemaining > 0) {
        showMessage(`æœ¬æ—¥ã‚ã¨ ${todayRemaining} å› ä½¿ç”¨å¯èƒ½ã§ã™ã€‚`, false, true);
      } else {
        showMessage(`æœ¬æ—¥ã®ä½¿ç”¨å›æ•°ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚`, true, true);
      }
    }

    function showMessage(text, warning = false, append = false) {
      const msg = document.getElementById("message");
      if (!append) msg.textContent = text;
      else msg.textContent += `\n${text}`;
      msg.className = warning ? "warning" : "";
    }

    async function handleUse() {
      const btn = document.getElementById("use-btn");
      btn.disabled = true;
      btn.textContent = "å‡¦ç†ä¸­...";

      try {
        const todayUses = await getTodayUses();
        if (todayUses >= MAX_USES_PER_DAY) {
          showMessage(`æœ¬æ—¥ã®ä½¿ç”¨å›æ•°ä¸Šé™ (${MAX_USES_PER_DAY}å›) ã«é”ã—ã¾ã—ãŸã€‚`, true);
          return;
        }

        const success = await logUse();
        if (!success) {
          showMessage("ä½¿ç”¨ã®è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèª", true);
          return;
        }

        const [totalUses, todayUsesNew] = await Promise.all([getTotalUses(), getTodayUses()]);
        const remaining = Math.max(0, TOTAL_REFILLS - totalUses);
        const remainingToday = MAX_USES_PER_DAY - todayUsesNew;

        updateUI(remaining, remainingToday);

      } catch (e) {
        showMessage("äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: " + e.message, true);
      } finally {
        btn.disabled = false;
        btn.textContent = "ä½¿ç”¨ã™ã‚‹";
      }
    }

    async function downloadCSV() {
      const btn = document.getElementById("download-btn");
      btn.disabled = true;
      btn.textContent = "æº–å‚™ä¸­...";

      try {
        const res = await client.get(`/detergent_logs`, {
          params: {
            user_id: `eq.${UID}`,
            order: 'used_at',
            select: 'used_at, amount_ml'
          }
        });

        if (res.data.length === 0) {
          alert("å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
          return;
        }

        let csv = "æ—¥æ™‚,ä½¿ç”¨é‡(ml)\n";
        res.data.forEach(log => {
          const utc = new Date(log.used_at);
          const jst = new Date(utc.getTime() + 9 * 60 * 60 * 1000);
          const dateStr = jst.toLocaleString('ja-JP', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
          }).replace(/\//g, '-');
          csv += `"${dateStr}",${log.amount_ml}\n`;
        });

        const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `æ´—å‰¤ä½¿ç”¨å±¥æ­´_${getJSTDateString()}.csv`;
        a.click();
        URL.revokeObjectURL(url);

        showMessage("CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚");
      } catch (e) {
        showMessage("å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
      } finally {
        setTimeout(() => {
          btn.disabled = false;
          btn.textContent = "å±¥æ­´ã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
        }, 1000);
      }
    }

    async function init() {
      try {
        const [totalUses, todayUses] = await Promise.all([
          getTotalUses(),
          getTodayUses()
        ]);

        const remaining = Math.max(0, TOTAL_REFILLS - totalUses);
        const remainingToday = MAX_USES_PER_DAY - todayUses;

        updateUI(remaining, remainingToday);
        document.getElementById("use-btn").disabled = todayUses >= MAX_USES_PER_DAY;

      } catch (e) {
        showMessage("åˆæœŸåŒ–å¤±æ•—ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèª", true);
        console.error("Init error:", e);
      }
    }

    document.getElementById("use-btn").addEventListener("click", handleUse);
    document.getElementById("download-btn").addEventListener("click", downloadCSV);

    init();
  </script>
</body>
</html>
