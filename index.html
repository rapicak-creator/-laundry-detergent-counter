<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>洗剤カウンター</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 40px; }
    .progress { width: 100%; background: #eee; height: 24px; border-radius: 12px; overflow: hidden; margin: 20px 0; }
    .bar { height: 100%; background: #2e7d32; width: 0%; transition: width 0.6s ease; color: #fff; display:flex; align-items:center; justify-content:center; font-weight:bold; }
    button { padding: 15px 30px; font-size: 18px; margin: 20px; background:#1976d2; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    button:hover { background:#1565c0; }
    button:disabled { background:#999; cursor: not-allowed; }
    #message { margin-top: 15px; font-size: 16px; color: #333; white-space: pre-line; }
    #message.warning { color: #d32f2f; font-weight:bold; }
    #download-btn { background: #4caf50; }
    #download-btn:hover { background: #388e3c; }
    #use-btn { background: #ff9800; }
    #use-btn:hover { background: #f57c00; }
  </style>
</head>
<body>
  <h1>部屋干しスーパークリーン</h1>
  <p>残り: <span id="remaining">読み込み中...</span> 回</p>
  <div class="progress"><div class="bar" id="bar">0%</div></div>
  <button id="use-btn" disabled>使用する</button>
  <button id="download-btn">履歴をCSVでダウンロード</button>
  <p><small>※1回の使用量: 22ml</small></p>
  <div id="message" role="status" aria-live="polite"></div>

  <script>
    // ===== 設定（必要に応じて変更）=====
    const SUPABASE_URL = "https://vnzyqgrkjkeiwahainnc.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuenlxZ3JramtlaXdhaGFpbm5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzM1OTIsImV4cCI6MjA3MTYwOTU5Mn0.r5tCYxwjEagU7ZejUzv8Pblt1Pn5xtppE89lMdFsVHg";
    const UID = "ABC123";
    const TOTAL_REFILLS = 83;         // 全体の最大使用可能回数
    const MAX_USES_PER_DAY = 3;       // 1日あたりの最大使用回数
    // ===================================

    const client = axios.create({
      baseURL: `${SUPABASE_URL}/rest/v1`,
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`,
      },
      timeout: 10000,
    });

    // JSTの日付文字列 (YYYY-MM-DD)
    function getJSTDateString(date = new Date()) {
      const jst = new Date(date.getTime() + 9 * 60 * 60 * 1000);
      return jst.toISOString().split("T")[0];
    }

    // JSTの範囲をUTCで取得（Supabase用）
    function getTodayUTCRange() {
      const today = getJSTDateString();
      const start = new Date(today + "T00:00:00+09:00").toISOString();
      const end = new Date(today + "T23:59:59+09:00").toISOString();
      return { start, end };
    }

    // 今日の使用回数を取得（リトライ付き）
    async function getTodayUses() {
      const { start, end } = getTodayUTCRange();
      for (let i = 0; i < 3; i++) {
        try {
          const res = await client.get(`/detergent_logs`, {
            params: {
              select: 'id',
              and: `user_id.eq.${UID},used_at.gte.${start},used_at.lt.${end}`
            }
          });
          return res.data.length;
        } catch (e) {
          await new Promise(r => setTimeout(r, 500));
        }
      }
      return 0;
    }

    // 総使用回数を取得
    async function getTotalUses() {
      for (let i = 0; i < 3; i++) {
        try {
          const res = await client.get(`/detergent_logs`, {
            params: {
              select: 'id',
              user_id: `eq.${UID}`
            }
          });
          return res.data.length;
        } catch (e) {
          await new Promise(r => setTimeout(r, 500));
        }
      }
      return 0;
    }

    // 使用ログを記録
    async function logUse() {
      try {
        await client.post(`/detergent_logs`, {
          user_id: UID,
          amount_ml: 22,
          used_at: new Date().toISOString()
        });
        return true;
      } catch (e) {
        console.error("ログ記録失敗:", e.response?.data || e.message);
        return false;
      }
    }

    // UI更新（メッセージも一元管理）
    function updateUI(remainingTotal, remainingToday) {
      // 残り回数
      document.getElementById("remaining").textContent = remainingTotal;

      // プログレスバー
      const percent = Math.max(0, (remainingTotal / TOTAL_REFILLS) * 100);
      const bar = document.getElementById("bar");
      bar.style.width = percent + "%";
      bar.textContent = `${Math.round(percent)}%`;

      // メッセージ（完全リセット）
      const msg = document.getElementById("message");
      msg.textContent = "";

      // 残量メッセージ
      if (remainingTotal <= 10) {
        msg.textContent += `⚠️ 残り${remainingTotal}回です。補充をご検討ください。\n`;
        msg.className = "warning";
      } else if (remainingTotal <= TOTAL_REFILLS / 2) {
        msg.textContent += `残り${remainingTotal}回になりました（半分以下）。\n`;
        msg.className = "warning";
      } else {
        msg.textContent += `残り${remainingTotal}回使えます。\n`;
        msg.className = "";
      }

      // 本日使用可能回数
      if (remainingToday > 0) {
        msg.textContent += `本日あと ${remainingToday} 回 使用可能です。`;
      } else {
        msg.textContent += `本日の使用回数上限に達しました。`;
        msg.className = "warning";
      }
    }

    // 使用処理
    async function handleUse() {
      const btn = document.getElementById("use-btn");
      btn.disabled = true;
      btn.textContent = "処理中...";

      try {
        const todayUsesBefore = await getTodayUses();
        if (todayUsesBefore >= MAX_USES_PER_DAY) {
          updateUI(TOTAL_REFILLS - await getTotalUses(), 0);
          return;
        }

        const success = await logUse();
        if (!success) {
          showMessage("使用の記録に失敗しました。", true);
          return;
        }

        // 記録後に再取得（整合性確保）
        const todayUsesAfter = await getTodayUses();
        const totalUses = await getTotalUses();

        const remainingTotal = Math.max(0, TOTAL_REFILLS - totalUses);
        const remainingToday = MAX_USES_PER_DAY - todayUsesAfter;

        updateUI(remainingTotal, remainingToday);

      } catch (e) {
        showMessage("エラーが発生しました。", true);
      } finally {
        btn.disabled = false;
        btn.textContent = "使用する";
      }
    }

    // CSVダウンロード
    async function downloadCSV() {
      const btn = document.getElementById("download-btn");
      btn.disabled = true;
      btn.textContent = "準備中...";

      try {
        const res = await client.get(`/detergent_logs`, {
          params: {
            user_id: `eq.${UID}`,
            order: 'used_at',
            select: 'used_at, amount_ml'
          }
        });

        if (res.data.length === 0) {
          alert("履歴がありません。");
          return;
        }

        let csv = "日時,使用量(ml)\n";
        res.data.forEach(log => {
          const utc = new Date(log.used_at);
          const jst = new Date(utc.getTime() + 9 * 60 * 60 * 1000);
          const dateStr = jst.toLocaleString('ja-JP', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
          }).replace(/\//g, '-');
          csv += `"${dateStr}",${log.amount_ml}\n`;
        });

        const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `洗剤使用履歴_${getJSTDateString()}.csv`;
        a.click();
        URL.revokeObjectURL(url);

        showMessage("CSVをダウンロードしました。");
      } catch (e) {
        showMessage("履歴の取得に失敗しました。", true);
      } finally {
        setTimeout(() => {
          btn.disabled = false;
          btn.textContent = "履歴をCSVでダウンロード";
        }, 1000);
      }
    }

    // メッセージ表示（簡易版）
    function showMessage(text, warning = false) {
      const msg = document.getElementById("message");
      msg.textContent = text;
      msg.className = warning ? "warning" : "";
    }

    // 初期化
    async function init() {
      try {
        const [totalUses, todayUses] = await Promise.all([
          getTotalUses(),
          getTodayUses()
        ]);

        const remainingTotal = Math.max(0, TOTAL_REFILLS - totalUses);
        const remainingToday = MAX_USES_PER_DAY - todayUses;

        updateUI(remainingTotal, remainingToday);
        document.getElementById("use-btn").disabled = todayUses >= MAX_USES_PER_DAY;

      } catch (e) {
        showMessage("データの読み込みに失敗しました。\nネットワークを確認してください。", true);
      }
    }

    // イベント登録
    document.getElementById("use-btn").addEventListener("click", handleUse);
    document.getElementById("download-btn").addEventListener("click", downloadCSV);

    // 初期化
    init();
  </script>
</body>
</html>
