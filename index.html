<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>æ´—å‰¤ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 40px; }
    .progress { width: 100%; background: #eee; height: 24px; border-radius: 12px; overflow: hidden; margin: 20px 0; }
    .bar { height: 100%; background: #2e7d32; width: 0%; transition: width 0.6s ease; color: #fff; display:flex; align-items:center; justify-content:center; font-weight:bold; }
    button { padding: 12px 25px; font-size: 16px; margin: 10px; background:#1976d2; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    button:hover { background:#1565c0; }
    #message { margin-top: 15px; font-size: 16px; color: #333; }
    #message.warning { color: #d32f2f; font-weight:bold; }
  </style>
</head>
<body>
  <h1>éƒ¨å±‹å¹²ã—ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¯ãƒªãƒ¼ãƒ³</h1>
  <p>æ®‹ã‚Š: <span id="remaining">èª­ã¿è¾¼ã¿ä¸­...</span> å›</p>
  <div class="progress"><div class="bar" id="bar">0%</div></div>
  <button id="use-btn">ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹</button>
  <button id="csv-btn">å±¥æ­´CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
  <p><small>â€»1å›ã®ä½¿ç”¨é‡: 22ml</small></p>
  <div id="message" role="status" aria-live="polite"></div>

  <script>
    const SUPABASE_URL = "https://vnzyqgrkjkeiwahainnc.supabase.co";
    const SUPABASE_KEY = "YOUR_SERVICE_ROLE_KEY"; // âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã‚µãƒ¼ãƒãƒ¼çµŒç”±æ¨å¥¨
    const UID = "ABC123";
    const USER_EMAIL = "rapicak@gmail.com";
    const TOTAL = 83;

    const client = axios.create({
      baseURL: SUPABASE_URL + "/rest/v1",
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`,
      },
    });

    async function load() {
      try {
        const res = await client.get(`/detergent_usage?id=eq.${UID}`);
        if (res.data.length === 0) {
          await client.post(`/detergent_usage`, { id: UID, email: USER_EMAIL, current_uses: 0, notified_half: false, notified_low: false });
          updateUI(TOTAL);
        } else {
          const item = res.data[0];
          const remaining = TOTAL - item.current_uses;
          updateUI(remaining);
        }
      } catch (e) {
        showMessage("èª­ã¿è¾¼ã¿å¤±æ•—: " + e.message, true);
      }
    }

    async function useOnce() {
      try {
        const res = await client.get(`/detergent_usage?id=eq.${UID}`);
        const item = res.data[0];
        const newUses = item.current_uses + 1;
        const remaining = TOTAL - newUses;

        // ä½¿ç”¨å›æ•°æ›´æ–°
        await client.patch(`/detergent_usage?id=eq.${UID}`, { current_uses: newUses });

        // å±¥æ­´è¿½åŠ 
        await client.post(`/detergent_history`, {
          uid: UID,
          total_uses: newUses
        });

        updateUI(remaining);

      } catch (e) {
        showMessage("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message, true);
      }
    }

    function updateUI(remaining) {
      document.getElementById("remaining").textContent = remaining;
      const percent = Math.max(0, (remaining / TOTAL) * 100);
      const bar = document.getElementById("bar");
      bar.style.width = percent + "%";
      bar.textContent = Math.round(percent) + "%";

      if (remaining <= 10) {
        showMessage(`âš ï¸ æ®‹ã‚Š${remaining}å›ã§ã™ã€‚è£œå……ã‚’ã”æ¤œè¨ãã ã•ã„ã€‚`, true);
      } else if (remaining <= TOTAL/2) {
        showMessage(`æ®‹ã‚Š${remaining}å›ã«ãªã‚Šã¾ã—ãŸï¼ˆåŠåˆ†ä»¥ä¸‹ï¼‰ã€‚`, true);
      } else {
        showMessage(`ä½¿ç”¨ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚æ®‹ã‚Š${remaining}å›ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚`);
      }
    }

    function showMessage(text, warning=false) {
      const msg = document.getElementById("message");
      msg.textContent = text;
      msg.className = warning ? "warning" : "";
    }

    // ğŸ“Œ CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    async function downloadCSV() {
      try {
        const res = await client.get(`/detergent_history?uid=eq.${UID}&select=*`);
        const rows = res.data;

        if (!rows.length) {
          showMessage("å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“", true);
          return;
        }

        let csv = "id,uid,used_at,total_uses\n";
        rows.forEach(r => {
          csv += `${r.id},${r.uid},${r.used_at},${r.total_uses}\n`;
        });

        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "detergent_history.csv";
        a.click();
        URL.revokeObjectURL(url);
      } catch (e) {
        showMessage("CSVå–å¾—å¤±æ•—: " + e.message, true);
      }
    }

    document.getElementById("use-btn").addEventListener("click", useOnce);
    document.getElementById("csv-btn").addEventListener("click", downloadCSV);
    load();
  </script>
</body>
</html>
