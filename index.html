<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>洗剤カウンター</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 40px; }
    .progress { width: 100%; background: #eee; height: 20px; border-radius: 10px; overflow: hidden; }
    .bar { height: 100%; background: #4CAF50; width: 0%; }
    button { padding: 15px 30px; font-size: 18px; margin: 20px; }
  </style>
</head>
<body>
  <h1>部屋干しスーパークリーン</h1>
  <p>残り: <span id="remaining">読み込み中...</span> 回</p>
  <div class="progress"><div class="bar" id="bar"></div></div>
  <button onclick="useOnce()">使用済みにする</button>
  <p><small>※1回の使用量: 22ml</small></p>

  <script>
    const SUPABASE_URL = "https://vnzyqgrkjkeiwahainnc.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuenlxZ3JramtlaXdhaGFpbm5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzM1OTIsImV4cCI6MjA3MTYwOTU5Mn0.r5tCYxwjEagU7ZejUzv8Pblt1Pn5xtppE89lMdFsVHg";
    const UID = "ABC123";
    const USER_EMAIL = "rapicak@gmail.com";

    const client = axios.create({
      baseURL: SUPABASE_URL + "/rest/v1",
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`,
      },
    });

    async function load() {
      try {
        const res = await client.get(`/detergent_usage?id=eq.${UID}`);
        if (res.data.length === 0) {
          await client.post(`/detergent_usage`, { id: UID, email: USER_EMAIL });
          document.getElementById("remaining").textContent = "83";
          document.getElementById("bar").style.width = "100%";
        } else {
          const item = res.data[0];
          const remaining = 83 - item.current_uses;
          document.getElementById("remaining").textContent = remaining;
          document.getElementById("bar").style.width = (remaining / 83 * 100) + "%";
        }
      } catch (e) {
        alert("読み込み失敗: " + e.message);
      }
    }

    async function useOnce() {
      try {
        const res = await client.get(`/detergent_usage?id=eq.${UID}`);
        const item = res.data[0];
        const newUses = item.current_uses + 1;
        const remaining = 83 - newUses;

        await client.patch(`/detergent_usage?id=eq.${UID}`, { current_uses: newUses });

        // ✅ ブラウザから直接fetchしない！
        // 代わりに、自分のVercelのAPIを呼ぶ
        if (remaining <= 41 && !item.notified_half) {
          await fetch(`/api/send-email`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              type: "半分",
              remaining,
              to: USER_EMAIL
            })
          });
          await client.patch(`/detergent_usage?id=eq.${UID}`, { notified_half: true });
        }

        if (remaining <= 10 && !item.notified_low) {
          await fetch(`/api/send-email`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              type: "残りわずか",
              remaining,
              to: USER_EMAIL
            })
          });
          await client.patch(`/detergent_usage?id=eq.${UID}`, { notified_low: true });
        }

        alert(`使用登録しました。残り${remaining}回`);
        location.reload();
      } catch (e) {
        alert("エラー: " + e.message);
      }
    }

    load();
  </script>
</body>
</html>
