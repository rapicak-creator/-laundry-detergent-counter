<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ´—å‰¤ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 40px; }
    .progress { width: 100%; background: #eee; height: 20px; border-radius: 10px; overflow: hidden; }
    .bar { height: 100%; background: #4CAF50; width: 0%; }
    button { padding: 15px 30px; font-size: 18px; margin: 20px; }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>éƒ¨å±‹å¹²ã—ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¯ãƒªãƒ¼ãƒ³</h1>
  <p>æ®‹ã‚Š: <span id="remaining">èª­ã¿è¾¼ã¿ä¸­...</span> å›</p>
  <div class="progress"><div class="bar" id="bar"></div></div>
  <button onclick="useOnce()">ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹</button>
  <p><small>â€»1å›ã®ä½¿ç”¨é‡: 22ml</small></p>
  <p id="status"></p>

  <script>
    // ========== è¨­å®šã“ã“ã‹ã‚‰ ==========
    const SUPABASE_URL = "https://vnzyqgrkjkeiwahainnc.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuenlxZ3JramtlaXdhaGFpbm5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzM1OTIsImV4cCI6MjA3MTYwOTU5Mn0.r5tCYxwjEagU7ZejUzv8Pblt1Pn5xtppE89lMdFsVHg";
    const RESEND_API_KEY = "re_aZXUgXh9_CBra5j8HhfSEJAbwUQsNi4Zu";
    const UID = "ABC123";
    const USER_EMAIL = "rapicak@gmail.com"; // ãƒ¡ãƒ¼ãƒ«é€šçŸ¥å…ˆ
    // ========== è¨­å®šã“ã“ã¾ã§ ==========

    const client = axios.create({
      baseURL: SUPABASE_URL + "/rest/v1",
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`,
      },
    });

    async function load() {
      try {
        const res = await client.get(`/detergent_usage?id=eq.${UID}`);
        
        if (res.data.length === 0) {
          // åˆå›ï¼šãƒ‡ãƒ¼ã‚¿ä½œæˆ
          await client.post(`/detergent_usage`, {
            id: UID,
            email: USER_EMAIL,
            current_uses: 0,
            notified_half: false,
            notified_low: false
          });
          document.getElementById("remaining").textContent = "83";
          document.getElementById("bar").style.width = "100%";
          document.getElementById("status").textContent = "åˆå›è¨­å®šå®Œäº†";
        } else {
          const item = res.data[0];
          const remaining = 83 - item.current_uses;
          document.getElementById("remaining").textContent = remaining;
          document.getElementById("bar").style.width = (remaining / 83 * 100) + "%";
        }
      } catch (e) {
        console.error("èª­ã¿è¾¼ã¿å¤±æ•—", e);
        document.getElementById("status").innerHTML = `<span class="error">èª­ã¿è¾¼ã¿å¤±æ•—: ${e.message}</span>`;
      }
    }

    async function useOnce() {
      try {
        const res = await client.get(`/detergent_usage?id=eq.${UID}`);
        if (res.data.length === 0) throw new Error("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");

        const item = res.data[0];
        const newUses = item.current_uses + 1;
        const remaining = 83 - newUses;

        // ä½¿ç”¨å›æ•°æ›´æ–°
        await client.patch(`/detergent_usage?id=eq.${UID}`, {
          current_uses: newUses,
        });

        // ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ï¼ˆåŠåˆ†ï¼‰
        if (remaining <= 41 && !item.notified_half) {
          await sendEmail("åŠåˆ†", remaining);
          await client.patch(`/detergent_usage?id=eq.${UID}`, { notified_half: true });
        }

        // ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ï¼ˆæ®‹ã‚Šã‚ãšã‹ï¼‰
        if (remaining <= 10 && !item.notified_low) {
          await sendEmail("æ®‹ã‚Šã‚ãšã‹", remaining);
          await client.patch(`/detergent_usage?id=eq.${UID}`, { notified_low: true });
        }

        alert(`ä½¿ç”¨ç™»éŒ²ã—ã¾ã—ãŸã€‚æ®‹ã‚Š${remaining}å›`);
        location.reload();
      } catch (e) {
        console.error("ç™»éŒ²å¤±æ•—", e);
        alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
      }
    }

    async function sendEmail(type, remaining) {
      try {
        const response = await fetch("https://api.resend.com/emails", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${RESEND_API_KEY}`,
          },
          body: JSON.stringify({
            from: "onboarding@resend.dev", // Resendã®ãƒ†ã‚¹ãƒˆç”¨ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ç¢ºèªä¸è¦ï¼‰
            to: USER_EMAIL,
            subject: type === "åŠåˆ†" 
              ? "æ´—å‰¤ã®æ®‹é‡ãŒåŠåˆ†ã«ãªã‚Šã¾ã—ãŸ" 
              : "æ´—å‰¤ã®æ®‹ã‚ŠãŒå°‘ãªããªã£ã¦ã„ã¾ã™",
            text: `ã€Œéƒ¨å±‹å¹²ã—ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¯ãƒªãƒ¼ãƒ³ã€ã®æ®‹ã‚Šã¯ã‚ã¨${remaining}å›åˆ†ã§ã™ã€‚è£œå……ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚`,
          }),
        });

        if (!response.ok) {
          const error = await response.json();
          console.error("ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—:", error);
          document.getElementById("status").innerHTML = `<span class="error">ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: ${JSON.stringify(error)}</span>`;
        } else {
          console.log("âœ… ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ");
          document.getElementById("status").innerHTML = `<span class="success">ãƒ¡ãƒ¼ãƒ«é€šçŸ¥æ¸ˆ</span>`;
        }
      } catch (e) {
        console.error("ğŸ“§ é€ä¿¡ã‚¨ãƒ©ãƒ¼:", e);
        document.getElementById("status").innerHTML = `<span class="error">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${e.message}</span>`;
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
    load();
  </script>
</body>
</html>
