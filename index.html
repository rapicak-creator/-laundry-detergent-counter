<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ´—å‰¤ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</title>
  <script>
    // ãƒšãƒ¼ã‚¸æç”»å‰ã«ãƒ†ãƒ¼ãƒã‚’é©ç”¨ã—ã¦ FOUC ã‚’é˜²æ­¢
    (function () {
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = saved || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    /* ===== Theme Tokens ===== */
    :root {
      --bg: #f9f9f9;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --border: #e5e7eb;
      --bar: #2e7d32;
      --bar-text: #ffffff;
      --btn-bg: #1976d2;
      --btn-bg-hover: #1565c0;
      --btn-alt-bg: #4caf50;
      --btn-alt-hover: #388e3c;
      --warning: #d32f2f;
      --progress-track: #eeeeee;
      --shadow: 0 8px 24px rgba(0,0,0,.08);
      --radius: 14px;
    }
    [data-theme="dark"] {
      --bg: #0b0f14;
      --card: #0f1720;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --border: #243142;
      --bar: #22c55e;           /* ãƒ€ãƒ¼ã‚¯ã§å°‘ã—æ˜ã‚‹ã‚ã®ç·‘ */
      --bar-text: #0b0f14;
      --btn-bg: #2563eb;
      --btn-bg-hover: #1e40af;
      --btn-alt-bg: #16a34a;
      --btn-alt-hover: #15803d;
      --warning: #f87171;
      --progress-track: #1f2937;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
    }

    /* ===== Base ===== */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Apple Color Emoji", "Segoe UI Emoji";
      margin: 0; padding: 32px 16px;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(37,99,235,.08), transparent 40%),
                  radial-gradient(900px 600px at 120% 10%, rgba(34,197,94,.08), transparent 35%),
                  var(--bg);
      color: var(--text);
      transition: background-color .25s ease, color .25s ease;
    }
    .container {
      width: min(720px, 100%);
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 28px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    h1 {
      margin: 0;
      font-size: clamp(20px, 3.5vw, 28px);
      letter-spacing: .02em;
    }
    .desc {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 14px;
    }

    /* ===== Progress ===== */
    .kpis {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: end;
      gap: 12px;
      margin-top: 18px;
    }
    .remaining {
      font-size: clamp(16px, 2.8vw, 18px);
    }
    .progress {
      width: 100%;
      background: var(--progress-track);
      height: 24px;
      border-radius: 12px;
      overflow: hidden;
      margin: 14px 0 6px;
      border: 1px solid var(--border);
    }
    .bar {
      height: 100%;
      background: var(--bar);
      width: 0%;
      transition: width 0.6s ease;
      color: var(--bar-text);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    /* ===== Buttons ===== */
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 14px;
    }
    button {
      padding: 14px 18px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: transform .05s ease, filter .2s ease, background-color .2s ease;
      color: #ffffff;
      user-select: none;
    }
    button:active { transform: translateY(1px); }
    .btn-primary { background: var(--btn-bg); }
    .btn-primary:hover { background: var(--btn-bg-hover); }
    .btn-alt { background: var(--btn-alt-bg); }
    .btn-alt:hover { background: var(--btn-alt-hover); }
    .btn-ghost {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-ghost:hover { filter: brightness(1.1); }

    /* ===== Message ===== */
    #message {
      margin-top: 14px;
      font-size: 15px;
      min-height: 20px;
      color: var(--text);
    }
    #message.warning {
      color: var(--warning);
      font-weight: 700;
    }
    small { color: var(--muted); }

    /* ===== Accessibility ===== */
    @media (prefers-reduced-motion: reduce) {
      .bar { transition: none; }
      button { transition: none; }
    }
  </style>
</head>
<body>
  <main class="container" role="main" aria-labelledby="title">
    <header>
      <div>
        <h1 id="title">éƒ¨å±‹å¹²ã—ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¯ãƒªãƒ¼ãƒ³</h1>
        <p class="desc">è‡ªå‹•ã§æ®‹é‡ã‚’è¨˜éŒ²ã—ã€ã—ãã„å€¤ã§é€šçŸ¥ã—ã¾ã™ã€‚</p>
      </div>
      <div class="actions" style="margin:0">
        <button id="theme-btn" class="btn-ghost" aria-pressed="false" aria-label="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">ğŸŒ™ ãƒ€ãƒ¼ã‚¯</button>
      </div>
    </header>

    <section class="kpis" aria-live="polite">
      <div class="remaining">
        æ®‹ã‚Š: <strong><span id="remaining">èª­ã¿è¾¼ã¿ä¸­...</span></strong> å›
      </div>
      <div>
        <button id="download-btn" class="btn-alt">å±¥æ­´ã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </div>
    </section>

    <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-label="æ®‹é‡é€²æ—">
      <div class="bar" id="bar" aria-live="polite">0%</div>
    </div>

    <div class="actions">
      <!-- ä»»æ„: æ‰‹å‹•ã§ã€Œ1å›ä½¿ç”¨ã€ã‚’è¨˜éŒ²ã—ãŸã„å ´åˆã¯ã“ã®ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º -->
      <button id="use-btn" class="btn-primary">1å›ä½¿ç”¨ï¼ˆæ‰‹å‹•ï¼‰</button>
    </div>

    <p><small>â€»1å›ã®ä½¿ç”¨é‡: 22ml</small></p>
    <div id="message" role="status" aria-live="polite"></div>
  </main>

  <script>
    // ===== è¨­å®š =====
    const SUPABASE_URL = "https://vnzyqgrkjkeiwahainnc.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuenlxZ3JramtlaXdhaGFpbm5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzM1OTIsImV4cCI6MjA3MTYwOTU5Mn0.r5tCYxwjEagU7ZejUzv8Pblt1Pn5xtppE89lMdFsVHg";
    const UID = "ABC123";
    const USER_EMAIL = "rapicak@gmail.com";
    const MAX_USES_PER_DAY = 3;  // 1æ—¥æœ€å¤§ä½¿ç”¨å›æ•°
    const TOTAL_USES = 83;       // å…¨ä½“ã®ä½¿ç”¨å¯èƒ½å›æ•°

    // ===== Supabase ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆRESTï¼‰=====
    const client = axios.create({
      baseURL: `${SUPABASE_URL}/rest/v1`,
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`,
      },
      paramsSerializer: { indexes: null }
    });

    // ===== ãƒ†ãƒ¼ãƒåˆ‡æ›¿ =====
    const themeBtn = document.getElementById('theme-btn');
    function applyThemeLabel() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      themeBtn.textContent = isDark ? 'â˜€ï¸ ãƒ©ã‚¤ãƒˆ' : 'ğŸŒ™ ãƒ€ãƒ¼ã‚¯';
      themeBtn.setAttribute('aria-pressed', String(isDark));
    }
    themeBtn.addEventListener('click', () => {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      applyThemeLabel();
    });
    applyThemeLabel();

    // ===== ä»Šæ—¥ã®æ—¥ä»˜ (YYYY-MM-DD) =====
    function getToday() {
      return new Date().toISOString().split('T')[0];
    }

    // ===== ä»Šæ—¥ã®ä½¿ç”¨å›æ•°ã‚’å–å¾— =====
    async function getTodayUses() {
      try {
        const res = await client.get(`/daily_usage`, {
          params: {
            user_id: 'eq.' + UID,
            date: 'eq.' + getToday(),
            select: 'id,uses_count'
          }
        });
        return res.data.length > 0 ? res.data[0].uses_count : 0;
      } catch (e) {
        console.warn("ä»Šæ—¥ã®ä½¿ç”¨å›æ•°å–å¾—å¤±æ•—:", e.message);
        return 0;
      }
    }

    // ===== ä»Šæ—¥ã®ä½¿ç”¨å›æ•°ã‚’+1 =====
    async function incrementTodayUses() {
      const today = getToday();
      try {
        const res = await client.get(`/daily_usage`, {
          params: { user_id: 'eq.' + UID, date: 'eq.' + today, select: 'id,uses_count' }
        });

        if (res.data.length > 0) {
          await client.patch(`/daily_usage?id=eq.${res.data[0].id}`, {
            uses_count: res.data[0].uses_count + 1
          });
        } else {
          await client.post(`/daily_usage`, {
            user_id: UID,
            date: today,
            uses_count: 1
          });
        }
      } catch (e) {
        console.error("æœ¬æ—¥ã®ä½¿ç”¨å›æ•°è¨˜éŒ²å¤±æ•—:", e.message);
      }
    }

    // ===== ä½¿ç”¨ãƒ­ã‚°è¨˜éŒ² =====
    async function logUse() {
      try {
        await client.post(`/detergent_logs`, {
          user_id: UID,
          amount_ml: 22
        });
      } catch (e) {
        console.warn("ä½¿ç”¨ãƒ­ã‚°è¨˜éŒ²å¤±æ•—:", e.message);
      }
    }

    // ===== æ®‹ã‚Šå›æ•°ã‚’å–å¾—ãƒ»åˆæœŸåŒ– =====
    async function loadRemaining() {
      try {
        const res = await client.get(`/detergent_usage`, { params: { id: 'eq.' + UID } });
        if (res.data.length === 0) {
          // åˆå›ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ åˆæœŸåŒ–
          await client.post(`/detergent_usage`, {
            id: UID,
            email: USER_EMAIL,
            current_uses: 0,
            notified_half: false,
            notified_low: false
          });
          return { current_uses: 0, notified_half: false, notified_low: false };
        } else {
          return res.data[0];
        }
      } catch (e) {
        console.error("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—:", e.message);
        showMessage("ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
        return { current_uses: 0, notified_half: false, notified_low: false };
      }
    }

    // ===== æ®‹ã‚Šå›æ•°ã‚’æ›´æ–° =====
    async function updateRemaining(newUses) {
      try {
        await client.patch(`/detergent_usage?id=eq.${UID}`, {
          current_uses: newUses
        });
      } catch (e) {
        console.warn("æ®‹ã‚Šå›æ•°æ›´æ–°å¤±æ•—:", e.message);
      }
    }

    // ===== CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ =====
    async function downloadCSV() {
      try {
        const res = await client.get(`/detergent_logs`, {
          params: {
            user_id: 'eq.' + UID,
            order: 'used_at.desc',
            select: 'used_at,amount_ml'
          }
        });

        if (res.data.length === 0) {
          alert("ä½¿ç”¨å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
          return;
        }

        let csv = "æ—¥æ™‚,ä½¿ç”¨é‡(ml)\n";
        res.data.forEach(log => {
          const date = new Date(log.used_at).toLocaleString('ja-JP', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
          }).replace(/\//g, '-');
          csv += `"${date}",${log.amount_ml}\n`;
        });

        const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `æ´—å‰¤ä½¿ç”¨å±¥æ­´_${getToday()}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        showMessage("CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚");
      } catch (e) {
        showMessage("å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
      }
    }

    // ===== UIæ›´æ–° =====
    function updateUI(remaining) {
      document.getElementById("remaining").textContent = remaining;
      const percent = Math.max(0, (remaining / TOTAL_USES) * 100);
      const bar = document.getElementById("bar");
      bar.style.width = `${percent}%`;
      bar.textContent = `${Math.round(percent)}%`;
      document.querySelector('.progress').setAttribute('aria-valuenow', String(Math.round(percent)));

      if (remaining <= 10) {
        showMessage(`âš ï¸ æ®‹ã‚Š${remaining}å›ã§ã™ã€‚è£œå……ã‚’ã”æ¤œè¨ãã ã•ã„ã€‚`, true);
      } else if (remaining <= TOTAL_USES / 2) {
        showMessage(`æ®‹ã‚Š${remaining}å›ã«ãªã‚Šã¾ã—ãŸï¼ˆåŠåˆ†ä»¥ä¸‹ï¼‰ã€‚`);
      } else {
        showMessage(`æ®‹ã‚Š${remaining}å›ä½¿ãˆã¾ã™ã€‚`);
      }
    }

    // ===== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º =====
    function showMessage(text, warning = false) {
      const el = document.getElementById("message");
      el.textContent = text;
      el.className = warning ? "warning" : "";
    }

    // ===== ä½¿ç”¨å‡¦ç†ï¼ˆ1å›åˆ†ï¼‰=====
    async function useDetergent() {
      const todayUses = await getTodayUses();
      if (todayUses >= MAX_USES_PER_DAY) {
        const data = await loadRemaining();
        const remaining = TOTAL_USES - data.current_uses;
        updateUI(remaining);
        showMessage(`æœ¬æ—¥ã®ä½¿ç”¨å›æ•°ä¸Šé™ (${MAX_USES_PER_DAY}å›) ã«é”ã—ã¾ã—ãŸã€‚`, true);
        return;
      }

      const data = await loadRemaining();
      const newUses = (data.current_uses || 0) + 1;
      const remaining = TOTAL_USES - newUses;

      // DBæ›´æ–°
      await updateRemaining(newUses);
      await incrementTodayUses();
      await logUse();

      // ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ï¼ˆå¿…è¦æ™‚ï¼‰
      if (remaining <= TOTAL_USES / 2 && !data.notified_half) {
        try {
          await fetch(`/api/send-email`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ type: "åŠåˆ†", remaining, to: USER_EMAIL })
          });
          await client.patch(`/detergent_usage?id=eq.${UID}`, { notified_half: true });
        } catch (e) {
          console.warn("åŠåˆ†é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—:", e);
        }
      }
      if (remaining <= 10 && !data.notified_low) {
        try {
          await fetch(`/api/send-email`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ type: "æ®‹ã‚Šã‚ãšã‹", remaining, to: USER_EMAIL })
          });
          await client.patch(`/detergent_usage?id=eq.${UID}`, { notified_low: true });
        } catch (e) {
          console.warn("æ®‹ã‚Šã‚ãšã‹é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—:", e);
        }
      }

      // UIæ›´æ–°
      updateUI(remaining);

      // æœ¬æ—¥æ®‹ã‚Šå›æ•°
      const remainingToday = MAX_USES_PER_DAY - (todayUses + 1);
      if (remainingToday > 0) {
        showMessage(`æœ¬æ—¥ã‚ã¨ ${remainingToday} å› ä½¿ç”¨å¯èƒ½ã§ã™ã€‚`);
      }
    }

    // ===== ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² =====
    document.getElementById("download-btn").addEventListener("click", downloadCSV);
    document.getElementById("use-btn").addEventListener("click", () => {
      useDetergent().catch(e => {
        console.error("ä½¿ç”¨å‡¦ç†å¤±æ•—:", e);
        showMessage("å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
      });
    });

    // ===== ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ =====
    window.addEventListener("load", () => {
      // åˆå›è¡¨ç¤ºæ™‚ã«ç¾åœ¨æ®‹é‡ã‚’åæ˜ ï¼ˆè‡ªå‹•ã§1å›æ¶ˆè²»ã—ãŸããªã„å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
      loadRemaining()
        .then(data => {
          const remaining = TOTAL_USES - (data.current_uses || 0);
          updateUI(remaining);
        })
        .catch(e => {
          console.error("åˆæœŸåŒ–å¤±æ•—:", e);
          showMessage("åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
        });

      // ã‚‚ã—å¾“æ¥ã©ãŠã‚Šã€Œãƒšãƒ¼ã‚¸è¡¨ç¤ºã§1å›åˆ†ã‚’è‡ªå‹•æ¶ˆè²»ã€ã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã‚’æœ‰åŠ¹åŒ–
      // useDetergent().catch(e => {
      //   console.error("è‡ªå‹•ä½¿ç”¨å‡¦ç†å¤±æ•—:", e);
      //   showMessage("å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
      // });
    });
  </script>
</body>
</html>
