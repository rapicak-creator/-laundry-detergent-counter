<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ´—å‰¤ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ | UI/UXæ”¹å–„ç‰ˆ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Roboto:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <style>
    /* ğŸ¨ ãƒ‡ã‚¶ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰: CSSã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ */
    :root {
      /* ã‚«ãƒ©ãƒ¼ã‚·ã‚¹ãƒ†ãƒ  */
      --primary-color: #0ea5e9; /* Sky 500 */
      --primary-color-dark: #0284c7; /* Sky 600 */
      --primary-color-light: #f0f9ff; /* Sky 50 */
      --text-color-primary: #1e293b; /* Slate 800 */
      --text-color-secondary: #64748b; /* Slate 500 */
      --bg-color: #f8fafc; /* Slate 50 */
      --card-bg-color: #ffffff;
      --border-color: #e2e8f0; /* Slate 200 */
      --success-color: #10b981; /* Emerald 500 */
      --error-color: #ef4444; /* Red 500 */

      /* ã‚¿ã‚¤ãƒã‚°ãƒ©ãƒ•ã‚£ */
      --font-family-base: 'Noto Sans JP', sans-serif;
      --font-family-display: 'Roboto', sans-serif;
      --text-base-size: 1rem; /* 16px */
      --text-lg: 1.125rem;
      --text-xl: 1.25rem;
      --text-4xl: 2.25rem;

      /* ã‚¹ãƒšãƒ¼ã‚·ãƒ³ã‚° */
      --spacing-2: 0.5rem;
      --spacing-4: 1rem;
      --spacing-6: 1.5rem;
      --spacing-8: 2rem;
      
      /* ãã®ä»– */
      --border-radius: 0.75rem;
      --box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --transition-base: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã¨ãƒªã‚»ãƒƒãƒˆ */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-family-base);
      background-color: var(--bg-color);
      color: var(--text-color-primary);
      display: grid;
      place-items: center;
      min-height: 100vh;
      padding: var(--spacing-4);
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚«ãƒ¼ãƒ‰UI */
    .detergent-card {
      background-color: var(--card-bg-color);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: var(--spacing-6);
      width: 100%;
      max-width: 400px;
      text-align: center;
      overflow: hidden;
      position: relative;
    }
    
    /* ã‚«ãƒ¼ãƒ‰ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .detergent-card__header h1 {
      font-size: var(--text-xl);
      margin-bottom: var(--spacing-2);
    }
    .detergent-card__header p {
      font-size: var(--text-base-size);
      color: var(--text-color-secondary);
    }

    /* æ®‹é‡è¡¨ç¤ºã‚¨ãƒªã‚¢ */
    .detergent-card__status {
      margin: var(--spacing-6) 0;
      /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœ€ã‚‚æ³¨ç›®ã™ã‚‹æƒ…å ±ã‚’å¼·èª¿ */
      font-family: var(--font-family-display);
      font-weight: 700;
      color: var(--primary-color);
    }
    .detergent-card__remaining-count {
      font-size: var(--text-4xl);
      line-height: 1.1;
      /* ARIA Live Region: ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ãŒå¤‰æ›´ã‚’èª­ã¿ä¸Šã’ã‚‹ */
      aria-live: "polite";
    }
    .detergent-card__remaining-label {
      font-size: var(--text-base-size);
      font-family: var(--font-family-base);
      color: var(--text-color-secondary);
    }
    
    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
    .progress-bar {
      width: 100%;
      height: 12px;
      background-color: var(--border-color);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: var(--spacing-6);
    }
    .progress-bar__indicator {
      height: 100%;
      background-color: var(--primary-color);
      width: 0%;
      border-radius: 6px;
      transition: var(--transition-base); /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§æ»‘ã‚‰ã‹ã«å¤‰åŒ– */
    }

    /* ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ */
    .cta-button {
      width: 100%;
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: var(--spacing-4);
      font-size: var(--text-lg);
      font-weight: 700;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition-base);
    }
    /* âœ¨ ãƒã‚¤ã‚¯ãƒ­ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³: ãƒ›ãƒãƒ¼ã¨ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ */
    .cta-button:hover:not(:disabled) {
      background-color: var(--primary-color-dark);
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    .cta-button:focus-visible {
      outline: 3px solid var(--primary-color-light);
      outline-offset: 2px;
    }
    .cta-button:disabled {
      background-color: #94a3b8; /* Slate 400 */
      cursor: not-allowed;
      opacity: 0.7;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ */
    .loader {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(4px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition-base);
    }
    .loader.is-active {
      opacity: 1;
      visibility: visible;
    }
    .spinner {
      width: 48px;
      height: 48px;
      border: 5px solid var(--primary-color-light);
      border-bottom-color: var(--primary-color);
      border-radius: 50%;
      display: inline-block;
      animation: rotation 1s linear infinite;
    }
    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
    .toast {
      position: fixed;
      bottom: var(--spacing-6);
      left: 50%;
      transform: translateX(-50%) translateY(150%);
      padding: var(--spacing-4);
      border-radius: var(--border-radius);
      color: white;
      font-weight: 700;
      box-shadow: var(--box-shadow);
      z-index: 20;
      transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      opacity: 0;
    }
    .toast--success { background-color: var(--success-color); }
    .toast--error { background-color: var(--error-color); }
    .toast.is-visible {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
  </style>
</head>
<body>
  
  <main>
    <section class="detergent-card" aria-labelledby="card-heading">
      <div class="detergent-card__header">
        <h1 id="card-heading">éƒ¨å±‹å¹²ã—ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¯ãƒªãƒ¼ãƒ³</h1>
        <p>1å›ã®ä½¿ç”¨é‡: 22ml</p>
      </div>

      <figure class="detergent-card__status" aria-label="æ´—å‰¤ã®æ®‹ã‚Šå›æ•°">
        <div id="remaining" class="detergent-card__remaining-count" aria-live="polite">--</div>
        <figcaption class="detergent-card__remaining-label">æ®‹ã‚Šå›æ•°</figcaption>
      </figure>
      
      <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="83" aria-valuenow="0" aria-valuetext="æ®‹ã‚Šå›æ•°">
        <div id="bar" class="progress-bar__indicator"></div>
      </div>
      
      <button id="use-button" class="cta-button">1å›ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹</button>

      <div id="loader" class="loader">
        <div class="spinner"></div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <script>
    // ğŸš€ JavaScript UXå¼·åŒ–: åˆ†é›¢ã•ã‚ŒãŸé–¢å¿ƒäº‹ã¨çŠ¶æ…‹ç®¡ç†
    document.addEventListener('DOMContentLoaded', () => {

      // --- 1. å®šæ•°ã¨çŠ¶æ…‹ç®¡ç† ---
      const SUPABASE_URL = "https://vnzyqgrkjkeiwahainnc.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuenlxZ3JramtlaXdhaGFpbm5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzM1OTIsImV4cCI6MjA3MTYwOTU5Mn0.r5tCYxwjEagU7ZejUzv8Pblt1Pn5xtppE89lMdFsVHg";
      const UID = "ABC123";
      const USER_EMAIL = "rapicak@gmail.com";
      const TOTAL_USES = 83;

      // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’ä¸€å…ƒç®¡ç†
      const state = {
        isLoading: true,
        currentUses: 0,
        notifiedHalf: false,
        notifiedLow: false,
        get remaining() {
          return TOTAL_USES - this.currentUses;
        },
        get percentage() {
          return (this.remaining / TOTAL_USES) * 100;
        }
      };

      // --- 2. DOMè¦ç´ ã®å–å¾— ---
      const ui = {
        remainingEl: document.getElementById('remaining'),
        barEl: document.getElementById('bar'),
        progressBarEl: document.querySelector('.progress-bar'),
        buttonEl: document.getElementById('use-button'),
        loaderEl: document.getElementById('loader'),
        toastEl: document.getElementById('toast'),
      };

      // --- 3. APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ---
      const apiClient = axios.create({
        baseURL: `${SUPABASE_URL}/rest/v1`,
        headers: {
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`,
          "Content-Type": "application/json",
          "Prefer": "return=representation", // æ›´æ–°å¾Œã«ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
        },
      });

      // --- 4. UIæ›´æ–°é–¢æ•° ---
      const render = () => {
        // ãƒ­ãƒ¼ãƒ€ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤º
        ui.loaderEl.classList.toggle('is-active', state.isLoading);
        ui.buttonEl.disabled = state.isLoading;
        
        // ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
        if (state.currentUses === null) return;
        
        const remaining = state.remaining;
        ui.remainingEl.textContent = remaining;
        ui.barEl.style.width = `${state.percentage}%`;
        
        // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å±æ€§ã®æ›´æ–°
        ui.progressBarEl.setAttribute('aria-valuenow', remaining);
        ui.progressBarEl.setAttribute('aria-valuetext', `æ®‹ã‚Š${remaining}å›`);

        // æ®‹ã‚Šå›æ•°ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´
        if (remaining <= 0) {
          ui.buttonEl.textContent = "ä½¿ã„åˆ‡ã‚Šã¾ã—ãŸ";
          ui.buttonEl.disabled = true;
        } else {
          ui.buttonEl.textContent = "1å›ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹";
        }
      };

      const showToast = (message, type = 'success') => {
        ui.toastEl.textContent = message;
        ui.toastEl.className = `toast toast--${type}`;
        ui.toastEl.classList.add('is-visible');
        setTimeout(() => {
          ui.toastEl.classList.remove('is-visible');
        }, 3000);
      };

      // --- 5. ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯/APIé€šä¿¡ ---
      const loadInitialData = async () => {
        state.isLoading = true;
        render();
        try {
          const { data } = await apiClient.get(`/detergent_usage?id=eq.${UID}&select=*`);
          if (data.length === 0) {
            // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
            const { data: newUser } = await apiClient.post('/detergent_usage', {
              id: UID,
              email: USER_EMAIL,
              current_uses: 0,
              notified_half: false,
              notified_low: false
            });
            Object.assign(state, newUser[0]);
          } else {
            Object.assign(state, data[0]);
          }
        } catch (error) {
          console.error("èª­ã¿è¾¼ã¿å¤±æ•—:", error);
          showToast("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
        } finally {
          state.isLoading = false;
          render();
        }
      };

      const handleUseOnce = async () => {
        if (state.remaining <= 0) return;
        
        state.isLoading = true;
        render();

        try {
          const newUses = state.currentUses + 1;
          const remaining = TOTAL_USES - newUses;
          
          let patchData = { current_uses: newUses };
          let notificationType = null;

          // é€šçŸ¥ãƒ­ã‚¸ãƒƒã‚¯ã‚’åŠ¹ç‡åŒ–
          if (remaining <= 10 && !state.notified_low) {
            patchData.notified_low = true;
            notificationType = "æ®‹ã‚Šã‚ãšã‹";
          } else if (remaining <= 41 && !state.notified_half) {
            patchData.notified_half = true;
            notificationType = "åŠåˆ†";
          }

          // â­ï¸ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„: PATCHãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’1å›ã«ã¾ã¨ã‚ã‚‹
          const { data: updatedData } = await apiClient.patch(`/detergent_usage?id=eq.${UID}`, patchData);
          Object.assign(state, updatedData[0]);

          if (notificationType) {
            // Vercel APIã‚’å‘¼ã³å‡ºã™ (å®Ÿéš›ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ç½®ãæ›ãˆã¦ãã ã•ã„)
            // await fetch('/api/send-email', { ... });
            console.log(`${notificationType}ã®é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚`);
          }

          showToast(`ä½¿ç”¨ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼ æ®‹ã‚Š${state.remaining}å›`, "success");

        } catch (error) {
          console.error("æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
          showToast("æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", "error");
        } finally {
          state.isLoading = false;
          render();
        }
      };

      // --- 6. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¨åˆæœŸåŒ– ---
      ui.buttonEl.addEventListener('click', handleUseOnce);
      
      loadInitialData();
    });
  </script>
</body>
</html>
