<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detergent Pal | あなたの洗濯パートナー</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;800&family=Roboto:wght@700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    /* 🎨 100点デザインシステム: テーマ性と動的変化 */
    :root {
      /* 基本テーマカラー (Normal State) */
      --theme-primary: #38bdf8; /* Sky 400 */
      --theme-primary-dark: #0ea5e9; /* Sky 500 */
      --theme-secondary: #a78bfa; /* Violet 400 */
      --theme-bg-start: #e0f2fe; /* Sky 100 */
      --theme-bg-end: #f5f3ff; /* Violet 50 */
      --theme-text-primary: #1e293b; /* Slate 800 */
      --theme-text-secondary: #475569; /* Slate 600 */
      --theme-card-bg: rgba(255, 255, 255, 0.6);
      --theme-border: rgba(255, 255, 255, 0.9);
      
      /* タイポグラフィ */
      --font-family-base: 'M PLUS Rounded 1c', sans-serif;
      --font-family-display: 'Roboto', sans-serif;
      
      /* その他 */
      --border-radius: 1.5rem; /* 24px */
      --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
      --transition-super-smooth: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
      
      /* トースト通知 */
      --toast-bg: #1e293b;
      --toast-color: white;
      --spacing-2: 0.5rem;
      --spacing-4: 1rem;
      --spacing-6: 1.5rem;
      --radius-md: 0.5rem;
      --text-sm: 0.875rem;
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    /* 🟡 低残量テーマ (Low State) */
    .is-low {
      --theme-primary: #facc15; /* Yellow 400 */
      --theme-primary-dark: #eab308; /* Yellow 500 */
      --theme-bg-start: #fefce8; /* Yellow 50 */
      --theme-bg-end: #fffbeb; /* Amber 50 */
    }

    /* 🔴 緊急テーマ (Critical State) */
    .is-critical {
      --theme-primary: #f87171; /* Red 400 */
      --theme-primary-dark: #ef4444; /* Red 500 */
      --theme-bg-start: #fef2f2; /* Red 50 */
      --theme-bg-end: #fff1f2; /* Rose 50 */
    }
    
    /* ダークモード対応 */
    @media (prefers-color-scheme: dark) {
      :root {
        --theme-text-primary: #f1f5f9;
        --theme-text-secondary: #cbd5e1;
        --theme-card-bg: rgba(30, 41, 59, 0.8);
        --theme-border: rgba(71, 85, 105, 0.5);
        --toast-bg: #f1f5f9;
        --toast-color: #1e293b;
      }
    }
    
    /* --- 基本スタイル --- */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-family-base);
      display: grid;
      place-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--theme-bg-start), var(--theme-bg-end));
      transition: background 0.5s ease;
    }
    
    /* --- カードデザイン (グラスモーフィズム) --- */
    .detergent-pal-card {
      width: 100%;
      max-width: 380px;
      padding: 2rem;
      background: var(--theme-card-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: var(--border-radius);
      border: 1px solid var(--theme-border);
      box-shadow: var(--shadow);
      text-align: center;
      position: relative;
      overflow: hidden;
      transition: var(--transition-super-smooth);
    }
    
    /* 💧 波のアニメーション背景 */
    .wave-bg {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 50%; /* JSで高さを動的に変更 */
      background: linear-gradient(to top, var(--theme-primary), var(--theme-secondary));
      opacity: 0.1;
      border-radius: var(--border-radius);
      transition: height 1s cubic-bezier(0.22, 1, 0.36, 1), background 0.5s ease;
      z-index: -1;
    }
    .wave-bg::before, .wave-bg::after {
      content: '';
      position: absolute;
      width: 200%;
      height: 200%;
      top: -150%;
      left: 50%;
      background-color: var(--theme-bg-start);
      border-radius: 45%;
      transform: translateX(-50%) rotate(0);
      animation: wave 12s linear infinite;
      transition: background-color 0.5s ease;
    }
    .wave-bg::after {
      border-radius: 40%;
      animation: wave 20s linear infinite;
      animation-direction: reverse;
      opacity: 0.7;
    }
    @keyframes wave { to { transform: translateX(-50%) rotate(360deg); } }

    /* --- コンテンツ --- */
    h1 {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--theme-text-primary);
    }
    
    .status-display {
      margin: 2rem 0;
    }

    .remaining-count {
      font-family: var(--font-family-display);
      font-size: 5rem; /* 80px */
      font-weight: 700;
      color: var(--theme-primary);
      line-height: 1;
      transition: color 0.5s ease;
    }
    .remaining-label {
      font-weight: 800;
      color: var(--theme-text-secondary);
    }

    /* ✨ ユーザーを魅了するボタン */
    .use-button {
      width: 100%;
      padding: 1rem;
      border: none;
      border-radius: 50px;
      background: linear-gradient(45deg, var(--theme-primary), var(--theme-secondary));
      color: white;
      font-family: var(--font-family-base);
      font-size: 1.125rem;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: all 0.2s ease-out;
      position: relative;
      -webkit-tap-highlight-color: transparent; /* モバイルでのタップ色を消す */
    }
    .use-button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .use-button:active:not(:disabled) {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .use-button:disabled {
      filter: grayscale(80%);
      cursor: not-allowed;
      opacity: 0.6;
    }

    /* --- トースト通知 --- */
    .toast {
      position: fixed;
      bottom: var(--spacing-6);
      left: 50%;
      transform: translateX(-50%);
      background: var(--toast-bg);
      color: var(--toast-color);
      padding: var(--spacing-2) var(--spacing-4);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      box-shadow: var(--shadow-md);
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1000;
    }
    
    .toast.show {
      opacity: 1;
    }

    /* --- アクセシビリティ対応 --- */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }
  </style>
</head>
<body>

  <main>
    <section class="detergent-pal-card" id="card" aria-labelledby="card-heading">
      <div class="wave-bg" id="wave"></div>

      <h1 id="card-heading">部屋干しスーパークリーン</h1>
      
      <div class="status-display">
        <div class="remaining-count" id="remaining-count" aria-live="polite">--</div>
        <div class="remaining-label">残り回数</div>
      </div>
      
      <button class="use-button" id="use-button" disabled>
        <span id="button-text">読み込み中...</span>
      </button>
    </section>
  </main>

  <!-- トースト通知 -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // --- 1. 定数 & 状態管理 ---
      const TOTAL_USES = 83;
      const state = {
        isLoading: true,
        currentUses: 0,
        notifiedHalf: false,
        notifiedLow: false,
        get remaining() { return TOTAL_USES - this.currentUses; },
        get percentage() { return (this.remaining / TOTAL_USES) * 100; }
      };
      
      // --- 2. DOM要素 ---
      const ui = {
        card: document.getElementById('card'),
        remainingCount: document.getElementById('remaining-count'),
        button: document.getElementById('use-button'),
        buttonText: document.getElementById('button-text'),
        wave: document.getElementById('wave'),
        toast: document.getElementById('toast')
      };
      
      // --- 3. APIクライアント ---
      const SUPABASE_URL = "https://vnzyqgrkjkeiwahainnc.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuenlxZ3JramtlaXdhaGFpbm5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzM1OTIsImV4cCI6MjA3MTYwOTU5Mn0.r5tCYxwjEagU7ZejUzv8Pblt1Pn5xtppE89lMdFsVHg";
      const UID = "ABC123";
      
      const apiClient = axios.create({
        baseURL: SUPABASE_URL,
        headers: {
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`,
          "Content-Type": "application/json",
          Prefer: "return=representation"
        }
      });
      
      // --- 4. UI更新モジュール ---
      const UIModule = {
        // 数字をアニメーションさせる関数
        animateCount: (element, target) => {
          element.style.opacity = 0;
          element.style.transform = 'translateY(10px)';
          setTimeout(() => {
            element.textContent = target;
            element.style.opacity = 1;
            element.style.transform = 'translateY(0)';
          }, 150);
        },

        // コンテキストに応じたテーマ変更
        updateTheme: (remaining) => {
          ui.card.classList.remove('is-low', 'is-critical');
          if (remaining <= 10) {
            ui.card.classList.add('is-critical');
          } else if (remaining <= 41) {
            ui.card.classList.add('is-low');
          }
        },

        // トースト通知を表示
        showToast: (message, duration = 3000) => {
          ui.toast.textContent = message;
          ui.toast.classList.add('show');
          
          setTimeout(() => {
            ui.toast.classList.remove('show');
          }, duration);
        },

        // メインの描画関数
        render: () => {
          ui.button.disabled = state.isLoading || state.remaining <= 0;
          if (state.isLoading) {
            ui.buttonText.textContent = '読み込み中...';
          } else if (state.remaining <= 0) {
            ui.buttonText.textContent = '使い切りました！';
          } else {
            ui.buttonText.textContent = '1回使う';
          }
          
          if (!state.isLoading) {
            UIModule.animateCount(ui.remainingCount, state.remaining);
            UIModule.updateTheme(state.remaining);
            ui.wave.style.height = `${Math.max(state.percentage, 5)}%`; // 最低5%は表示
          }
        }
      };
      
      // --- 5. アプリケーションロジック ---
      
      // ✨ 喜びの演出: コンフェッティ！
      const triggerConfetti = () => {
        confetti({
          particleCount: 100,
          spread: 70,
          origin: { y: 0.6 }
        });
      };

      const loadInitialData = async () => {
        state.isLoading = true;
        UIModule.render();
        try {
          const { data } = await apiClient.get(`/rest/v1/detergent_usage?uid=eq.${UID}`);
          const serverData = data.length > 0 ? data[0] : { current_uses: 0, notified_half: false, notified_low: false };
          state.currentUses = serverData.current_uses || 0;
          state.notifiedHalf = serverData.notified_half || false;
          state.notifiedLow = serverData.notified_low || false;
          
          // 初期読み込み時のトースト通知
          if (!state.isLoading) {
            UIModule.showToast(`${state.remaining}回残っています`);
          }
        } catch (error) {
          console.error("読み込み失敗:", error);
          ui.buttonText.textContent = '読込エラー';
          UIModule.showToast('データの読み込みに失敗しました', 5000);
        } finally {
          state.isLoading = false;
          UIModule.render();
        }
      };

      const handleUseOnce = async () => {
        if (state.remaining <= 0) return;
        
        // 🚀 楽観的UI更新 (Optimistic UI Update)
        const previousState = {
          currentUses: state.currentUses,
          notifiedHalf: state.notifiedHalf,
          notifiedLow: state.notifiedLow
        };
        
        state.currentUses++;
        UIModule.render();
        triggerConfetti(); // UIを即時更新し、アニメーション実行！

        try {
          // バックグラウンドでAPI通信
          const patchData = { 
            current_uses: state.currentUses,
            updated_at: new Date().toISOString()
          };
          
          await apiClient.put(`/rest/v1/detergent_usage?uid=eq.${UID}`, patchData);
          
          // 成功時のトースト通知
          UIModule.showToast(`${state.remaining}回残っています`);
          
          // 通知ロジック
          if (state.remaining <= 10 && !state.notifiedLow) {
            UIModule.showToast('⚠️ 残りわずかです！もうすぐ使い切りです！', 5000);
            state.notifiedLow = true;
            await apiClient.patch(`/rest/v1/detergent_usage?uid=eq.${UID}`, { notified_low: true });
          } else if (state.remaining <= 41 && !state.notifiedHalf) {
            UIModule.showToast('🔔 洗剤の残量が半分になりました！', 4000);
            state.notifiedHalf = true;
            await apiClient.patch(`/rest/v1/detergent_usage?uid=eq.${UID}`, { notified_half: true });
          }
        } catch (error) {
          console.error("更新エラー:", error);
          // 失敗した場合、UIを元に戻す
          state.currentUses = previousState.currentUses;
          state.notifiedHalf = previousState.notifiedHalf;
          state.notifiedLow = previousState.notifiedLow;
          UIModule.render();
          UIModule.showToast('更新に失敗しました。もう一度お試しください。', 5000);
        }
      };

      // --- 6. 初期化 ---
      ui.button.addEventListener('click', handleUseOnce);
      loadInitialData();
    });
  </script>
</body>
</html>
